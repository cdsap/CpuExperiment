name: Run Gradle on PRs
on:
    push:
        branches: [ test_with_docker_image]
jobs:
    iterations:
        name: Generate versions
        runs-on: ubuntu-latest
        steps:
            - id: calculate_iterations
              run: |
                  iterations=" ["
                  for i in {1..5}
                  do
                    if [ $i == 1 ]
                    then
                      iterations="$iterations \"$i\""
                    else
                      iterations="$iterations  , \"$i\""
                    fi
                  done
                  iterations="$iterations ]"
                  echo "iterations=$iterations" >> $GITHUB_OUTPUT
                  echo $GITHUB_OUTPUT
        outputs:
            iterations: ${{ steps.calculate_iterations.outputs.iterations }}
    execution:
        needs: [iterations]
        strategy:
            matrix:
                variant: ["cdsap/android-builder:0.5"]
                runs:   ${{ fromJson(needs.iterations.outputs.iterations) }}
        runs-on: ubuntu-latest
        container:
            image: ${{ matrix.variant }}
            options: --device-read-iops=/dev/sda:10 --device-write-iops=/dev/sda:10
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v4
              with:
                  distribution: corretto
                  java-version: 17
            - name: Build
              run: |
                  df -h
                  lsblk
                  ./gradlew assembleDebug -Dscan.tag.${{github.run_number}}  -Dscan.tag.${{ matrix.variant }} -Dscan.tag.experiment-sda20000
              env:
                  DEVELOCITY_ACCESS_KEY: ${{ secrets.GE_SOLUTIONS_ACCESS_TOKEN }}
    execution2:
        needs: [iterations]
        strategy:
            matrix:
                variant: ["cdsap/android-builder:0.5"]
                runs:   ${{ fromJson(needs.iterations.outputs.iterations) }}
        runs-on: ubuntu-latest
        container:
            image: ${{ matrix.variant }}
            options: --blkio-weight 100
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v4
              with:
                  distribution: corretto
                  java-version: 17
            - name: Build
              run: |
                  df -h
                  lsblk
                  ./gradlew assembleDebug -Dscan.tag.${{github.run_number}}  -Dscan.tag.${{ matrix.variant }} -Dscan.tag.experiment-sda200000
              env:
                  DEVELOCITY_ACCESS_KEY: ${{ secrets.GE_SOLUTIONS_ACCESS_TOKEN }}
    execution3:
        needs: [iterations]
        strategy:
            matrix:
                variant: ["cdsap/android-builder:0.5"]
                runs:   ${{ fromJson(needs.iterations.outputs.iterations) }}
        runs-on: ubuntu-latest
        container:
            image: ${{ matrix.variant }}
            options: --blkio-weight 10
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v4
              with:
                  distribution: corretto
                  java-version: 17
            - name: Build
              run: |
                  df -h
                  lsblk
                  ./gradlew assembleDebug -Dscan.tag.${{github.run_number}}  -Dscan.tag.${{ matrix.variant }} -Dscan.tag.experiment-sda2000
              env:
                  DEVELOCITY_ACCESS_KEY: ${{ secrets.GE_SOLUTIONS_ACCESS_TOKEN }}
